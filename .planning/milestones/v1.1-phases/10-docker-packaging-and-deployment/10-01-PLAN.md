---
phase: 10-docker-packaging-and-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - .dockerignore
  - entrypoint.sh
autonomous: true
requirements:
  - DEPLOY-01

must_haves:
  truths:
    - "docker build completes successfully with a multi-stage build (builder stage + runtime stage)"
    - "The final image runs as non-root user appuser (UID 999)"
    - "HEALTHCHECK directive is present and uses Python urllib to probe /health"
    - "Build context excludes .venv, .git, credentials, and dev artifacts via .dockerignore"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build with uv builder and slim runtime"
      contains: "FROM ghcr.io/astral-sh/uv"
    - path: ".dockerignore"
      provides: "Build context exclusion rules"
      contains: ".venv"
    - path: "entrypoint.sh"
      provides: "Volume permission fix and privilege drop"
      contains: "chown"
  key_links:
    - from: "Dockerfile"
      to: "entrypoint.sh"
      via: "ENTRYPOINT directive"
      pattern: "ENTRYPOINT.*entrypoint"
    - from: "Dockerfile"
      to: "pyproject.toml"
      via: "uv sync --locked reads lockfile"
      pattern: "uv sync --locked"
    - from: "Dockerfile"
      to: "src/negotiation/health.py"
      via: "HEALTHCHECK probes /health endpoint"
      pattern: "urllib.*localhost:8000/health"
---

<objective>
Create the multi-stage Dockerfile, .dockerignore, and entrypoint.sh for the negotiation agent container.

Purpose: Establish the container image build pipeline -- builder stage installs dependencies with uv, runtime stage runs as non-root user with HEALTHCHECK. This is the foundation for the complete Docker deployment in plan 10-02.

Output: Three files (Dockerfile, .dockerignore, entrypoint.sh) that produce a working Docker image via `docker build`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-docker-packaging-and-deployment/10-RESEARCH.md
@pyproject.toml
@src/negotiation/app.py
@src/negotiation/config.py
@src/negotiation/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .dockerignore and entrypoint.sh</name>
  <files>.dockerignore, entrypoint.sh</files>
  <action>
Create `.dockerignore` at the project root with exclusions for:
- `.venv/`, `venv/` (virtual environments -- rebuilt in container)
- `.git/`, `.gitignore` (version control)
- `__pycache__/`, `*.py[cod]`, `*$py.class`, `*.so` (Python caches)
- `.pytest_cache/`, `.mypy_cache/`, `.ruff_cache/`, `.coverage`, `htmlcov/` (dev tools)
- `.idea/`, `.vscode/`, `*.swp`, `*.swo` (IDE)
- `data/` (persisted via volume, not image)
- `credentials.json`, `token.json`, `service_account.json`, `*.pem`, `*.key`, `.env`, `.env.*` (credentials -- NEVER bake into image)
- `.DS_Store` (OS)
- `.planning/`, `.claude/` (planning docs)
- `tests/` (not needed in production image)

Do NOT exclude `uv.lock` -- it is required for deterministic builds.

Create `entrypoint.sh` at the project root:
```bash
#!/bin/sh
set -e

# Fix ownership of the data volume mount point.
# Required because existing named volumes from prior runs may have root ownership.
# Docker Compose does not support per-volume user mapping.
# If the directory is already owned by appuser (999), chown is a no-op.
chown -R 999:999 /app/data

# Drop privileges and exec the CMD (which becomes PID 1).
# setpriv is part of util-linux, included in Debian slim images.
exec setpriv --reuid=999 --regid=999 --init-groups "$@"
```

The entrypoint runs as root (no USER directive before ENTRYPOINT in the Dockerfile). It fixes volume permissions then drops to the non-root user via `setpriv`. The `exec` ensures the application process becomes PID 1 for proper signal handling.
  </action>
  <verify>
Run: `test -f .dockerignore && test -f entrypoint.sh && echo "Files exist"`. Verify .dockerignore contains `.venv/` and does NOT contain `uv.lock`. Verify entrypoint.sh contains `chown -R 999:999 /app/data` and `setpriv`.
  </verify>
  <done>.dockerignore excludes build artifacts, credentials, and dev files. entrypoint.sh fixes volume ownership and drops to non-root user via setpriv.</done>
</task>

<task type="auto">
  <name>Task 2: Create multi-stage Dockerfile with HEALTHCHECK</name>
  <files>Dockerfile</files>
  <action>
Create `Dockerfile` at the project root with two stages:

**BUILD STAGE** (named `builder`):
- Base image: `ghcr.io/astral-sh/uv:python3.12-bookworm-slim`
- Set env vars: `UV_COMPILE_BYTECODE=1`, `UV_LINK_MODE=copy`, `UV_NO_DEV=1`, `UV_PYTHON_DOWNLOADS=0`
- WORKDIR `/app`
- First RUN layer: Install dependencies only (cached unless pyproject.toml or uv.lock changes):
  ```
  RUN --mount=type=cache,target=/root/.cache/uv \
      --mount=type=bind,source=uv.lock,target=uv.lock \
      --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
      uv sync --locked --no-install-project
  ```
- COPY entire project: `COPY . /app`
- Second RUN layer: Install the project itself:
  ```
  RUN --mount=type=cache,target=/root/.cache/uv \
      uv sync --locked --no-editable
  ```

**RUNTIME STAGE:**
- Base image: `python:3.12-slim-bookworm`
- Create non-root system user (UID/GID 999):
  ```
  RUN groupadd --system --gid 999 appuser \
   && useradd --system --gid 999 --uid 999 --no-create-home --shell /usr/sbin/nologin appuser
  ```
- Create data directory with correct ownership (inherited by new named volumes):
  ```
  RUN mkdir -p /app/data/credentials \
   && chown -R appuser:appuser /app/data
  ```
- Copy application from builder with appuser ownership:
  `COPY --from=builder --chown=appuser:appuser /app /app`
- Copy entrypoint as root-owned (it runs as root to do chown):
  ```
  COPY --chown=root:root entrypoint.sh /entrypoint.sh
  RUN chmod +x /entrypoint.sh
  ```
- Copy config and knowledge_base directories (needed at runtime for YAML configs and KB markdown):
  ```
  COPY --chown=appuser:appuser config/ /app/config/
  COPY --chown=appuser:appuser knowledge_base/ /app/knowledge_base/
  ```
- Set PATH to include venv: `ENV PATH="/app/.venv/bin:$PATH"`
- WORKDIR `/app`
- HEALTHCHECK with self-kill pattern (per success criteria #4 requiring auto-restart):
  ```
  HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
      CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" \
      || kill 1
  ```
  Uses Python urllib (no curl in slim image). The `|| kill 1` sends SIGTERM to PID 1 if health check fails 3 times, causing container exit. Combined with `restart: unless-stopped` in docker-compose.yml (plan 10-02), this achieves auto-restart on health failure.

  Timing: `--start-period=30s` gives the app 30 seconds to start (success criteria: GET /health returns 200 within 30 seconds). `--interval=30s` checks every 30s after that. `--retries=3` means 3 consecutive failures before killing.
- ENTRYPOINT: `["/entrypoint.sh"]`
- CMD: `["python", "-m", "negotiation.app"]`

The CMD uses `python -m negotiation.app` because the project uses hatchling build system and `uv sync --no-editable` installs the package into site-packages. The `if __name__ == "__main__": asyncio.run(main())` block in app.py will execute.

Do NOT set `USER appuser` in the Dockerfile -- the entrypoint runs as root to fix volume permissions, then drops to appuser via setpriv.
  </action>
  <verify>
Run: `docker build -t negotiation-agent:test .` from the project root. Verify:
1. Build completes without errors (both stages succeed)
2. `docker inspect negotiation-agent:test --format='{{json .Config.Healthcheck}}'` shows the HEALTHCHECK configuration
3. `docker inspect negotiation-agent:test --format='{{.Config.Entrypoint}}'` shows `[/entrypoint.sh]`
4. `docker inspect negotiation-agent:test --format='{{.Config.Cmd}}'` shows `[python -m negotiation.app]`

If `docker build` fails with setpriv-related issues, fall back to installing gosu:
Add to runtime stage before COPY entrypoint: `RUN apt-get update && apt-get install -y --no-install-recommends gosu && rm -rf /var/lib/apt/lists/*`
Change entrypoint.sh `setpriv` line to: `exec gosu appuser "$@"`
  </verify>
  <done>Multi-stage Dockerfile exists with: (1) uv builder stage with cached dependency layer, (2) slim runtime stage with non-root appuser (UID 999), (3) HEALTHCHECK using Python urllib with self-kill pattern, (4) entrypoint.sh as ENTRYPOINT for volume permission handling.</done>
</task>

</tasks>

<verification>
After both tasks, verify the complete Docker image:
1. `docker build -t negotiation-agent:test .` succeeds
2. `docker inspect negotiation-agent:test` shows HEALTHCHECK, ENTRYPOINT, and CMD correctly configured
3. Image does NOT contain `.venv/`, `.git/`, `credentials.json`, `token.json`, or `.env` (verified by .dockerignore)
4. The runtime stage uses `python:3.12-slim-bookworm` (NOT Alpine) to avoid grpcio/musl issues
</verification>

<success_criteria>
- `docker build .` completes with a multi-stage build (builder + runtime stages)
- Runtime image has non-root user appuser (UID/GID 999)
- HEALTHCHECK directive probes /health with Python urllib and kills PID 1 on failure
- .dockerignore prevents credentials, .venv, .git from entering the build context
- entrypoint.sh fixes volume permissions and drops to non-root user
</success_criteria>

<output>
After completion, create `.planning/phases/10-docker-packaging-and-deployment/10-01-SUMMARY.md`
</output>

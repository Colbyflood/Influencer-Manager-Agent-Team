---
phase: 10-docker-packaging-and-deployment
plan: 02
type: execute
wave: 2
depends_on:
  - "10-01"
files_modified:
  - docker-compose.yml
autonomous: true
requirements:
  - DEPLOY-02

must_haves:
  truths:
    - "Running docker compose up starts the agent container"
    - "SQLite database persists across docker compose down / docker compose up cycles"
    - "Credential files persist in /app/data/credentials/ across container restarts"
    - "All credential paths are overridden via environment variables to /app/data/credentials/"
    - "Container restarts automatically on crash via restart: unless-stopped"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Single-service compose with named volume for persistent data"
      contains: "agent_data"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "build: . directive"
      pattern: "build:"
    - from: "docker-compose.yml"
      to: "src/negotiation/config.py"
      via: "Environment variables override Settings defaults for Docker paths"
      pattern: "AUDIT_DB_PATH.*GMAIL_TOKEN_PATH.*GMAIL_CREDENTIALS_PATH"
    - from: "docker-compose.yml"
      to: ".env"
      via: "env_file: .env loads secrets from host"
      pattern: "env_file"
---

<objective>
Create docker-compose.yml with a named volume for data persistence and verify the complete Docker deployment works end-to-end.

Purpose: Complete the deployment target -- `docker compose up` starts the agent with SQLite and credential files persisting across container lifecycle events. This fulfills the phase goal of "deploy to any VM with docker compose up."

Output: docker-compose.yml file with named volume `agent_data` mounting at `/app/data`, environment variable overrides for all credential paths, and restart policy for crash recovery.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-docker-packaging-and-deployment/10-RESEARCH.md
@.planning/phases/10-docker-packaging-and-deployment/10-01-SUMMARY.md
@src/negotiation/config.py
@Dockerfile
@entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker-compose.yml with named volume and path overrides</name>
  <files>docker-compose.yml</files>
  <action>
Create `docker-compose.yml` at the project root:

```yaml
services:
  agent:
    build: .
    container_name: negotiation-agent
    restart: unless-stopped
    env_file: .env
    ports:
      - "${WEBHOOK_PORT:-8000}:8000"
    volumes:
      - agent_data:/app/data
    environment:
      # Production mode
      - PRODUCTION=true
      # Database path (inside the named volume)
      - AUDIT_DB_PATH=/app/data/audit.db
      # Credential paths (inside the named volume)
      - GMAIL_TOKEN_PATH=/app/data/credentials/token.json
      - GMAIL_CREDENTIALS_PATH=/app/data/credentials/credentials.json
      - SHEETS_SERVICE_ACCOUNT_PATH=/app/data/credentials/service_account.json

volumes:
  agent_data:
    name: negotiation-agent-data
```

Key design decisions:
- `restart: unless-stopped` -- restarts on crash/reboot but NOT after manual `docker compose stop`. Combined with the HEALTHCHECK `|| kill 1` pattern in the Dockerfile, this achieves auto-restart when /health stops responding.
- Single named volume `agent_data` mounted at `/app/data` -- holds BOTH the SQLite database (`audit.db` + WAL files) and credential files (`credentials/` subdirectory). One volume is simpler to manage, backup, and reason about.
- `env_file: .env` loads secrets (SLACK_BOT_TOKEN, SLACK_APP_TOKEN, ANTHROPIC_API_KEY, etc.) from the host `.env` file. These are NOT in the `environment:` block to keep secrets out of the compose file.
- `environment:` block overrides Settings defaults so credential paths point into the volume. The defaults in config.py (`Path("token.json")`, `Path("credentials.json")`) resolve to `/app/token.json` in Docker (CWD is /app), which is outside the volume. The overrides redirect to `/app/data/credentials/` inside the volume.
- `AUDIT_DB_PATH=/app/data/audit.db` -- the default in config.py (`Path("data/audit.db")`) would also resolve to `/app/data/audit.db` since CWD is /app, but we set it explicitly for clarity and to avoid depending on CWD.
- `SHEETS_SERVICE_ACCOUNT_PATH=/app/data/credentials/service_account.json` -- the default (`~/.config/gspread/service_account.json`) would not work in Docker (no home directory for the non-root user).
- Port mapping uses `${WEBHOOK_PORT:-8000}:8000` -- allows the host port to be overridden via `.env` while the container always listens on 8000.
- Named volume `negotiation-agent-data` -- the `name:` field provides a human-readable name in `docker volume ls` output.

No `user: "999:999"` directive -- the entrypoint.sh handles permission fixing as root and then drops to appuser (UID 999) via setpriv. If we set `user:`, the entrypoint would run as appuser and could not `chown` the volume.
  </action>
  <verify>
Run: `docker compose config` from the project root to validate the compose file syntax. Verify output includes:
1. The `agent_data` volume definition
2. The `AUDIT_DB_PATH`, `GMAIL_TOKEN_PATH`, `GMAIL_CREDENTIALS_PATH`, `SHEETS_SERVICE_ACCOUNT_PATH` environment variables
3. The `restart: unless-stopped` policy
4. The volume mount `agent_data:/app/data`
  </verify>
  <done>docker-compose.yml exists with: named volume `agent_data` at `/app/data`, all credential paths overridden to `/app/data/credentials/`, restart: unless-stopped policy, env_file for secrets, and explicit container name.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Docker build and compose configuration end-to-end</name>
  <files></files>
  <action>
Run the following verification steps to confirm the complete Docker setup works:

1. **Build the image:** `docker compose build` -- must succeed with multi-stage build.

2. **Inspect image layers:** `docker inspect negotiation-agent:latest` (or the image built by compose) and verify:
   - HEALTHCHECK is configured with interval=30s, timeout=5s, start-period=30s, retries=3
   - ENTRYPOINT is `["/entrypoint.sh"]`
   - CMD is `["python", "-m", "negotiation.app"]`

3. **Verify non-root user exists in image:**
   `docker run --rm --entrypoint cat negotiation-agent:latest /etc/passwd | grep appuser`
   Should show `appuser:x:999:999:...`

4. **Verify .dockerignore worked:** Confirm excluded files are NOT in the image:
   `docker run --rm --entrypoint sh negotiation-agent:latest -c "test -d /app/.venv && echo FAIL || echo PASS"`
   `docker run --rm --entrypoint sh negotiation-agent:latest -c "test -f /app/.env && echo FAIL || echo PASS"`
   `docker run --rm --entrypoint sh negotiation-agent:latest -c "test -d /app/.git && echo FAIL || echo PASS"`
   All should print PASS.

5. **Verify compose config:** `docker compose config` should produce valid YAML with all expected settings.

6. **Verify volume persistence setup:** Run a quick check that the data directory exists in the image:
   `docker run --rm --entrypoint ls negotiation-agent:latest -la /app/data/`
   Should show the `credentials` subdirectory owned by appuser (uid 999).

If `docker compose build` or the image is not yet tagged, use `docker build -t negotiation-agent:test .` and adjust inspect commands accordingly.

NOTE: Do NOT run `docker compose up` -- the agent requires real credentials (.env secrets, Gmail tokens) that are not available in the CI/test environment. The verification confirms the Docker configuration is correct without starting the full application.
  </action>
  <verify>
All 6 verification steps pass:
1. `docker compose build` completes successfully
2. Image inspection shows HEALTHCHECK, ENTRYPOINT, CMD
3. appuser exists in /etc/passwd with UID 999
4. .venv, .env, .git are NOT present in the image
5. `docker compose config` produces valid output
6. /app/data/credentials directory exists with correct ownership
  </verify>
  <done>Docker build succeeds with multi-stage build. Image runs as non-root user. HEALTHCHECK is configured. Named volume mount point exists with correct ownership. Compose file validates. No credentials or dev artifacts in the image.</done>
</task>

</tasks>

<verification>
After both tasks, the complete Phase 10 Docker deployment is verified:
1. `docker compose build` succeeds (multi-stage Dockerfile)
2. `docker compose config` shows named volume, path overrides, restart policy
3. Image has non-root appuser (UID 999) and HEALTHCHECK directive
4. /app/data directory in image is owned by appuser, ready for named volume mount
5. Credentials and dev artifacts excluded from image via .dockerignore
6. Environment variables override all credential paths to /app/data/credentials/
</verification>

<success_criteria>
- docker-compose.yml exists with named volume `agent_data` at `/app/data`
- All credential paths (GMAIL_TOKEN_PATH, GMAIL_CREDENTIALS_PATH, SHEETS_SERVICE_ACCOUNT_PATH) are overridden to /app/data/credentials/ via environment variables
- AUDIT_DB_PATH is set to /app/data/audit.db (inside the volume, co-locating WAL files)
- restart: unless-stopped ensures container restarts on crash
- docker compose build succeeds and docker compose config validates
- No credentials, .venv, .git, or dev artifacts are in the built image
</success_criteria>

<output>
After completion, create `.planning/phases/10-docker-packaging-and-deployment/10-02-SUMMARY.md`
</output>

---
phase: 07-integration-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/negotiation/app.py
  - tests/test_orchestration.py
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "process_inbound_email passes real CPM from negotiation context to pre_check instead of hardcoded 0.0"
    - "Inbound emails are logged to the audit trail via audit_logger.log_email_received before the pre_check gate"
    - "Audit log entry includes campaign_id, influencer_name, thread_id, email_body, and negotiation_state"
    - "All existing 681 tests pass with no regressions"
  artifacts:
    - path: "src/negotiation/app.py"
      provides: "Real CPM in pre_check call and audit_logger.log_email_received call in process_inbound_email"
      contains: "log_email_received"
    - path: "tests/test_orchestration.py"
      provides: "Tests verifying real CPM in pre_check and audit logging of inbound emails"
      contains: "log_email_received"
  key_links:
    - from: "src/negotiation/app.py (process_inbound_email)"
      to: "src/negotiation/audit/logger.py (log_email_received)"
      via: "services.get('audit_logger') then direct method call"
      pattern: "audit_logger\\.log_email_received"
    - from: "src/negotiation/app.py (process_inbound_email)"
      to: "src/negotiation/slack/dispatcher.py (pre_check)"
      via: "float(context.get('next_cpm', ...)) passed as proposed_cpm"
      pattern: "proposed_cpm=float"
---

<objective>
Fix hardcoded CPM value in pre_check gate and wire audit logging for inbound emails in process_inbound_email.

Purpose: ISSUE-02 means the CPM-over-threshold trigger in pre_check never fires because proposed_cpm is always 0.0. MISSING-A means inbound emails are never logged to the audit trail, leaving a gap in DATA-03's "every sent/received email" requirement. Both fixes are in the same function (process_inbound_email in app.py).

Output: Patched app.py with real CPM in pre_check and audit logging of received emails, plus regression tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration-hardening/07-RESEARCH.md
@src/negotiation/app.py
@src/negotiation/slack/dispatcher.py
@src/negotiation/slack/triggers.py
@src/negotiation/audit/logger.py
@tests/test_orchestration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass real CPM to pre_check and add audit logging for inbound emails (ISSUE-02 + MISSING-A)</name>
  <files>
    src/negotiation/app.py
    tests/test_orchestration.py
  </files>
  <action>
**In `src/negotiation/app.py`, function `process_inbound_email`:**

Two changes in the same function, applied in order from top to bottom:

**Change A (MISSING-A): Add audit_logger.log_email_received call**

After line ~647 where `context` is extracted from `thread_state["context"]` and BEFORE the pre_check gate (Step 3), insert:

```python
        # Log inbound email to audit trail (DATA-03: every received email)
        audit_logger = services.get("audit_logger")
        if audit_logger is not None:
            audit_logger.log_email_received(
                campaign_id=context.get("campaign_id"),
                influencer_name=str(context.get("influencer_name", "")),
                thread_id=inbound.thread_id,
                email_body=inbound.body_text,
                negotiation_state=str(context.get("negotiation_state", "")),
                intent_classification=None,  # Not yet classified at receipt time
            )
```

Place this between the `round_count = thread_state["round_count"]` line and the `# Step 3: Run pre-check gates` comment. Use the same indent level as surrounding code.

**Change B (ISSUE-02): Replace hardcoded proposed_cpm=0.0 with real CPM**

In the `dispatcher.pre_check(...)` call (currently at lines ~651-659), change:
```python
proposed_cpm=0.0,           # REMOVE
```
to:
```python
proposed_cpm=float(context.get("next_cpm", 0)),
```

Keep `intent_confidence=1.0` as-is. This is CORRECT because at pre_check time, intent classification has NOT happened yet. Passing 1.0 means "don't fire the ambiguous_intent trigger" -- which is right since we have no confidence data. The intent gate only makes sense after classification (which happens inside process_influencer_reply). The CPM gate is what was broken (0.0 never exceeds the 30.0 threshold).

Note: `context.get("next_cpm")` returns a `Decimal` (set by `build_negotiation_context`). The `float()` conversion is needed because `pre_check` accepts `proposed_cpm: float` and `evaluate_triggers` uses `>` comparison with `float` threshold. `Decimal > float` works in Python but `float(Decimal)` is explicit and cleaner for mypy.

**In `tests/test_orchestration.py`:**

Read the existing test file to understand the `_base_services()` helper and `_make_mock_influencer_row` patterns. Then add these tests to the `TestProcessInboundEmail` class:

1. **Test: real CPM passed to pre_check**
```python
def test_process_inbound_email_passes_real_cpm_to_pre_check(self) -> None:
    """pre_check receives proposed_cpm from context.next_cpm, not hardcoded 0.0."""
```
Set up services with a mock dispatcher. Set `context["next_cpm"]` to `Decimal("25.50")`. Run `process_inbound_email` via `asyncio.run()`. Assert `dispatcher.pre_check` was called with `proposed_cpm=25.5` (float). Use `mock_dispatcher.pre_check.call_args` to inspect the kwargs.

2. **Test: audit_logger.log_email_received called for inbound emails**
```python
def test_process_inbound_email_logs_received_email_to_audit(self) -> None:
    """Inbound emails are logged via audit_logger.log_email_received."""
```
Set up services with a mock audit_logger. Run `process_inbound_email` via `asyncio.run()`. Assert `audit_logger.log_email_received.assert_called_once_with(...)` with the expected kwargs (campaign_id, influencer_name, thread_id, email_body, negotiation_state, intent_classification=None).

3. **Test: audit logging works when audit_logger is None**
```python
def test_process_inbound_email_no_audit_logger_no_crash(self) -> None:
    """When audit_logger is not in services, processing continues without error."""
```
Set up services WITHOUT "audit_logger" key. Run `process_inbound_email` via `asyncio.run()`. Assert no `KeyError` -- function completes normally. Use `services.pop("audit_logger", None)` to remove it from `_base_services()`.

Follow the existing test patterns in the file: `asyncio.run()` for async tests, `MagicMock()` for service mocks, `patch()` for asyncio.to_thread.
  </action>
  <verify>
Run: `cd "/Users/colbyflood/Influencer Manager Agent Team/Influencer-Manager-Agent-Team" && python -m pytest tests/test_orchestration.py -v`

All existing orchestration tests pass plus the 3 new tests pass.

Then run full suite:
`cd "/Users/colbyflood/Influencer Manager Agent Team/Influencer-Manager-Agent-Team" && python -m pytest --tb=short -q`

All 681+ tests pass.

Verify the code changes:
`grep -n "proposed_cpm" src/negotiation/app.py` -- should show `float(context.get("next_cpm"` instead of `0.0`
`grep -n "log_email_received" src/negotiation/app.py` -- should show the new audit call
  </verify>
  <done>
process_inbound_email passes `float(context.get("next_cpm", 0))` as proposed_cpm to pre_check -- the CPM-over-threshold trigger now fires when the real negotiation CPM exceeds the 30.0 threshold. intent_confidence remains 1.0 (correct: no intent data available at pre_check time). Inbound emails are logged to the audit trail via `audit_logger.log_email_received()` before the pre_check gate runs, completing DATA-03's "every received email" requirement. All 681+ tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_orchestration.py -v` -- ISSUE-02 + MISSING-A tests pass
2. `python -m pytest --tb=short -q` -- Full suite: 681+ tests pass, zero failures
3. `grep -n "proposed_cpm=float" src/negotiation/app.py` -- confirms real CPM wiring
4. `grep -n "log_email_received" src/negotiation/app.py` -- confirms audit logging call exists
5. `grep -n "intent_confidence=1.0" src/negotiation/app.py` -- confirms intent_confidence left at 1.0 (intentional: no classification data at pre_check time)
</verification>

<success_criteria>
- pre_check receives real CPM from negotiation context (not 0.0)
- Inbound emails logged to audit trail with campaign_id, influencer_name, thread_id, email_body, negotiation_state
- No crash when audit_logger is absent from services
- intent_confidence=1.0 preserved (correct for pre-classification stage)
- All 681+ tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration-hardening/07-02-SUMMARY.md`
</output>

---
phase: 07-integration-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/negotiation/campaign/ingestion.py
  - src/negotiation/sheets/models.py
  - src/negotiation/sheets/client.py
  - tests/campaign/test_ingestion.py
  - tests/sheets/test_models.py
  - tests/sheets/test_client.py
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "ingest_campaign completes without error when slack_notifier is None"
    - "InfluencerRow includes engagement_rate field defaulting to None"
    - "SheetsClient.get_all_influencers passes engagement_rate from Sheet record to InfluencerRow"
    - "CampaignCPMTracker.get_flexibility receives real engagement_rate via build_negotiation_context getattr"
    - "All existing 681 tests still pass with no regressions"
  artifacts:
    - path: "src/negotiation/campaign/ingestion.py"
      provides: "Null-guarded slack_notifier calls in ingest_campaign"
      contains: "if slack_notifier is not None"
    - path: "src/negotiation/sheets/models.py"
      provides: "engagement_rate optional field on InfluencerRow"
      contains: "engagement_rate"
    - path: "src/negotiation/sheets/client.py"
      provides: "engagement_rate wiring in get_all_influencers"
      contains: "engagement_rate=record.get"
  key_links:
    - from: "src/negotiation/sheets/client.py"
      to: "src/negotiation/sheets/models.py"
      via: "InfluencerRow construction with engagement_rate kwarg"
      pattern: "engagement_rate=record\\.get"
    - from: "src/negotiation/app.py"
      to: "src/negotiation/sheets/models.py"
      via: "getattr(sheet_data, 'engagement_rate', None) in build_negotiation_context"
      pattern: "getattr.*engagement_rate"
---

<objective>
Fix Slack null-guard crash in campaign ingestion and activate engagement-rate pricing by adding the missing field to InfluencerRow and wiring it through SheetsClient.

Purpose: ISSUE-01 prevents campaign ingestion from working when SLACK_BOT_TOKEN is absent (crashes on NoneType.post_escalation). ISSUE-03 means CampaignCPMTracker.get_flexibility always receives None for engagement_rate, so engagement-quality pricing premiums never activate. Both are small surgical fixes with tests.

Output: Patched ingestion.py, models.py, client.py with regression tests confirming all fixes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration-hardening/07-RESEARCH.md
@src/negotiation/campaign/ingestion.py
@src/negotiation/sheets/models.py
@src/negotiation/sheets/client.py
@tests/campaign/test_ingestion.py
@tests/sheets/test_models.py
@tests/sheets/test_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add slack_notifier null-guard in ingest_campaign (ISSUE-01)</name>
  <files>
    src/negotiation/campaign/ingestion.py
    tests/campaign/test_ingestion.py
  </files>
  <action>
In `src/negotiation/campaign/ingestion.py`, wrap the two `slack_notifier.post_escalation(...)` calls with `if slack_notifier is not None:` guards:

1. **Line ~287** (Step 6 comment): Wrap the campaign-ingestion-started notification:
```python
if slack_notifier is not None:
    slack_notifier.post_escalation(
        blocks=[...],
        fallback_text=...,
    )
```

2. **Line ~323** (Step 7 loop): Wrap the per-missing-influencer notification inside the `for` loop:
```python
for name in missing_influencers:
    if slack_notifier is not None:
        slack_notifier.post_escalation(
            blocks=[...],
            fallback_text=...,
        )
```

Do NOT change the existing code inside the `post_escalation` calls -- only add the `if` guard around each call. Indent the existing block content under the new `if`.

In `tests/campaign/test_ingestion.py`, add a new async test to `TestIngestCampaign` (or at module level following existing patterns):

```python
@pytest.mark.anyio()
async def test_ingest_campaign_slack_notifier_none_does_not_crash(
    tmp_path: Path,
) -> None:
    """When slack_notifier is None, ingest_campaign completes without error."""
```

This test should:
- Write a minimal campaign_fields.yaml config to tmp_path (reuse existing `_write_config` helper if present, or create inline)
- Mock `httpx.AsyncClient` to return a task with custom_fields matching the config
- Mock `sheets_client.find_influencer` to return a valid `InfluencerRow`
- Call `await ingest_campaign(task_id="t1", api_token="tok", sheets_client=sheets_client, slack_notifier=None, config_path=config_path)`
- Assert it returns without raising `AttributeError`
- Assert `result["campaign"]` is a `Campaign` instance
- Assert `result["found_influencers"]` has the expected count

Follow the existing test patterns: `@pytest.mark.anyio()`, `MagicMock()` for sync mocks, `AsyncMock()` for async context managers, `patch("negotiation.campaign.ingestion.httpx.AsyncClient")`.

Also add a test for the case where some influencers are missing AND slack_notifier is None:
```python
@pytest.mark.anyio()
async def test_ingest_campaign_missing_influencers_slack_none(tmp_path: Path) -> None:
    """Missing influencers with slack_notifier=None does not crash."""
```
This should have `sheets_client.find_influencer` raise `ValueError` for one name, and verify the function completes with `missing_influencers` populated.
  </action>
  <verify>
Run: `cd "/Users/colbyflood/Influencer Manager Agent Team/Influencer-Manager-Agent-Team" && python -m pytest tests/campaign/test_ingestion.py -v`

All existing tests pass plus the 2 new tests pass. No `AttributeError` on `NoneType`.
  </verify>
  <done>
ingest_campaign completes without error when slack_notifier is None -- both for the campaign-start notification and the per-missing-influencer notifications. Existing tests with `slack_notifier=MagicMock()` still pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add engagement_rate field to InfluencerRow and wire through SheetsClient (ISSUE-03)</name>
  <files>
    src/negotiation/sheets/models.py
    src/negotiation/sheets/client.py
    tests/sheets/test_models.py
    tests/sheets/test_client.py
  </files>
  <action>
**In `src/negotiation/sheets/models.py`:**

Add `engagement_rate: float | None = None` as the LAST field in `InfluencerRow`, AFTER `max_rate` and BEFORE the `@field_validator("min_rate", "max_rate", ...)` decorator. This field must NOT be included in the `coerce_from_sheet_float` validator (it is `float | None`, not `Decimal`).

```python
    max_rate: Decimal
    engagement_rate: float | None = None

    @field_validator("min_rate", "max_rate", mode="before")
```

**In `src/negotiation/sheets/client.py`:**

In `get_all_influencers()`, add `engagement_rate=record.get("Engagement Rate")` to the `InfluencerRow(...)` constructor call (after `max_rate=record["Max Rate"]`). Using `.get()` means the field is `None` when the Sheet column is absent -- safe since the field accepts `None`.

```python
rows.append(
    InfluencerRow(
        name=str(record["Name"]),
        email=str(record["Email"]),
        platform=str(record["Platform"]),
        handle=str(record["Handle"]),
        average_views=int(record["Average Views"]),
        min_rate=record["Min Rate"],
        max_rate=record["Max Rate"],
        engagement_rate=record.get("Engagement Rate"),
    )
)
```

**In `tests/sheets/test_models.py`:**

Add 3 tests to the existing `TestInfluencerRow` class (or at module level following existing patterns). If a `_make()` helper exists, use it:

1. `test_engagement_rate_defaults_to_none` -- Construct InfluencerRow WITHOUT engagement_rate, assert `row.engagement_rate is None`.
2. `test_engagement_rate_accepts_float` -- Construct with `engagement_rate=4.5`, assert `row.engagement_rate == 4.5`.
3. `test_engagement_rate_accepts_none_explicitly` -- Construct with `engagement_rate=None`, assert `row.engagement_rate is None`.

**In `tests/sheets/test_client.py`:**

Add a test verifying that when the Sheet record includes an "Engagement Rate" column, `get_all_influencers` passes it through to the InfluencerRow. Mock the worksheet's `get_all_records()` to return a record with `"Engagement Rate": 4.5` and assert the returned row has `engagement_rate == 4.5`. Also test the absent-column case: a record WITHOUT "Engagement Rate" should produce `engagement_rate is None`.

**Orphan decisions (no code changes needed):**
- `get_pay_range` on SheetsClient: Keep as-is. It is a valid convenience method, tested, not harmful. No action.
- `create_audited_email_receive` in `audit/wiring.py`: Keep the function and its tests. It remains a valid utility. Keep it exported from `audit/__init__.py`. No action needed -- Plan 02 uses direct `log_email_received()` call for MISSING-A (simpler pattern).
  </action>
  <verify>
Run: `cd "/Users/colbyflood/Influencer Manager Agent Team/Influencer-Manager-Agent-Team" && python -m pytest tests/sheets/ -v`

All existing sheets tests pass plus the new engagement_rate tests pass. No `ValidationError` from existing `InfluencerRow(...)` calls that omit engagement_rate.

Then run the full suite to check for regressions:
`cd "/Users/colbyflood/Influencer Manager Agent Team/Influencer-Manager-Agent-Team" && python -m pytest --tb=short -q`

All 681+ tests pass.
  </verify>
  <done>
InfluencerRow has `engagement_rate: float | None = None` field. SheetsClient.get_all_influencers reads "Engagement Rate" column from Sheet records (None when absent). The existing `getattr(sheet_data, "engagement_rate", None)` in app.py build_negotiation_context now returns the real value instead of falling through to None, so CampaignCPMTracker.get_flexibility receives real engagement data for premium calculations. All existing tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/campaign/test_ingestion.py -v` -- ISSUE-01 null-guard tests pass
2. `python -m pytest tests/sheets/ -v` -- ISSUE-03 engagement_rate tests pass
3. `python -m pytest --tb=short -q` -- Full suite: 681+ tests pass, zero failures
4. `grep -n "if slack_notifier is not None" src/negotiation/campaign/ingestion.py` -- confirms both guards exist
5. `grep -n "engagement_rate" src/negotiation/sheets/models.py src/negotiation/sheets/client.py` -- confirms field and wiring
</verification>

<success_criteria>
- ingest_campaign does not crash when slack_notifier is None
- InfluencerRow has engagement_rate field (float | None, defaults to None)
- SheetsClient.get_all_influencers passes engagement_rate from records
- Orphan functions (get_pay_range, create_audited_email_receive) kept as utilities -- no removal
- All 681+ tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration-hardening/07-01-SUMMARY.md`
</output>

---
phase: 08-settings-and-health-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/negotiation/config.py
  - src/negotiation/app.py
  - src/negotiation/auth/credentials.py
  - src/negotiation/slack/app.py
  - src/negotiation/slack/client.py
  - src/negotiation/campaign/webhook.py
  - src/negotiation/audit/cli.py
autonomous: true
requirements:
  - CONFIG-01
  - STATE-03

must_haves:
  truths:
    - "Agent loads all configuration from a single pydantic-settings Settings class with .env file support"
    - "No raw os.environ calls remain in any src/negotiation/ application module"
    - "Agent refuses to start in production mode when Gmail token, Sheets SA, or Slack token is missing"
    - "Agent logs warnings but still starts in development mode when credentials are missing"
    - "SecretStr fields (slack_bot_token, slack_app_token, anthropic_api_key) never leak in logs or error output"
  artifacts:
    - path: "src/negotiation/config.py"
      provides: "Settings class, get_settings(), validate_credentials()"
      min_lines: 80
      contains: "class Settings"
    - path: "pyproject.toml"
      provides: "pydantic-settings dependency"
      contains: "pydantic-settings"
  key_links:
    - from: "src/negotiation/app.py"
      to: "src/negotiation/config.py"
      via: "Settings() instantiation in main()"
      pattern: "from negotiation\\.config import"
    - from: "src/negotiation/app.py"
      to: "src/negotiation/config.py"
      via: "validate_credentials() call before service init"
      pattern: "validate_credentials"
    - from: "src/negotiation/config.py"
      to: "pydantic_settings"
      via: "BaseSettings import"
      pattern: "from pydantic_settings import BaseSettings"
---

<objective>
Create a centralized, typed configuration system using pydantic-settings and implement fail-fast startup credential validation.

Purpose: Replace 22 scattered os.environ calls across 6 source files with a single validated Settings class, eliminating an entire category of runtime bugs (wrong types, missing vars, typos). Add startup credential validation so the agent refuses to run in production without required credentials, catching misconfigurations immediately instead of failing silently mid-operation.

Output: `src/negotiation/config.py` with Settings class + credential validation; all 6 existing source files refactored to use Settings; `pydantic-settings` added to dependencies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-settings-and-health-infrastructure/08-RESEARCH.md
@src/negotiation/app.py
@src/negotiation/auth/credentials.py
@src/negotiation/slack/app.py
@src/negotiation/slack/client.py
@src/negotiation/campaign/webhook.py
@src/negotiation/audit/cli.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config module with Settings class and credential validation</name>
  <files>
    pyproject.toml
    src/negotiation/config.py
  </files>
  <action>
1. Add `"pydantic-settings>=2.13.0"` to the `dependencies` list in `pyproject.toml`, after the existing `"pydantic>=2.12,<3"` line.

2. Run `uv sync` to install the new dependency.

3. Create `src/negotiation/config.py` with:

   a. A `Settings(BaseSettings)` class with `model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8", case_sensitive=False)`. Map ALL 15 environment variables from the research inventory:
      - `production: bool = False`
      - `webhook_port: int = 8000`
      - `agent_email: str = ""`
      - `audit_db_path: Path = Path("data/audit.db")`
      - `gmail_token_path: Path = Path("token.json")`
      - `gmail_credentials_path: Path = Path("credentials.json")`
      - `gmail_pubsub_topic: str = ""`
      - `google_sheets_key: str = ""`
      - `sheets_service_account_path: Path = Path("~/.config/gspread/service_account.json")`
      - `slack_bot_token: SecretStr = SecretStr("")` (default empty, not required -- validation handles production enforcement)
      - `slack_app_token: SecretStr = SecretStr("")`
      - `slack_escalation_channel: str = ""`
      - `slack_agreement_channel: str = ""`
      - `anthropic_api_key: SecretStr = SecretStr("")`
      - `clickup_api_token: str = ""`
      - `clickup_webhook_secret: str = ""`

   b. A `get_settings()` function decorated with `@lru_cache` that returns `Settings()`. This enables test overrides and avoids re-parsing env on every call.

   c. A `validate_credentials(settings: Settings) -> None` function that:
      - Collects all errors into a `list[str]` before exiting (don't exit on first error -- report ALL problems)
      - Only enforces validation when `settings.production` is `True` (per research pitfall 4: preserve dev experience)
      - When `production=True`, checks:
        * `settings.gmail_token_path` file exists
        * `settings.sheets_service_account_path.expanduser()` file exists
        * `settings.slack_bot_token.get_secret_value()` is non-empty
        * `settings.slack_app_token.get_secret_value()` is non-empty
      - When `production=False`, logs warnings via structlog for each missing credential but does NOT exit
      - On failure in production: logs each error via `structlog.get_logger().error(...)`, prints a clear "=== STARTUP FAILED ===" block to stderr, calls `sys.exit(1)`

   d. IMPORTANT: Keep `config.py` self-contained with ZERO imports from the `negotiation` package (only stdlib, pydantic, pydantic_settings, structlog). This prevents circular imports (research pitfall 5).

   e. Wrap `Settings()` instantiation in `get_settings()` with a try/except for `ValidationError` that logs only `e.errors()` (not the full exception), to avoid SecretStr leaks in error messages (research pitfall 1).
  </action>
  <verify>
    - `uv sync` completes without errors
    - `python -c "from negotiation.config import Settings, get_settings, validate_credentials; s = get_settings(); print(type(s))"` prints `<class 'negotiation.config.Settings'>`
    - `ruff check src/negotiation/config.py` passes
    - `grep -r "os.environ" src/negotiation/config.py` returns no matches (config.py must not use os.environ itself)
  </verify>
  <done>
    Settings class exists with all 15+ environment variables as typed fields. get_settings() returns a cached instance. validate_credentials() enforces credential presence in production mode and logs warnings in dev mode. pydantic-settings is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all os.environ calls with Settings across 6 source files</name>
  <files>
    src/negotiation/app.py
    src/negotiation/auth/credentials.py
    src/negotiation/slack/app.py
    src/negotiation/slack/client.py
    src/negotiation/campaign/webhook.py
    src/negotiation/audit/cli.py
  </files>
  <action>
1. **src/negotiation/app.py** (17 os.environ calls -- largest refactor):
   a. Import `from negotiation.config import get_settings, validate_credentials` at top.
   b. In `main()`:
      - Replace `is_production = os.environ.get("PRODUCTION", "").lower() in (...)` with `settings = get_settings()` then `is_production = settings.production`.
      - Call `validate_credentials(settings)` AFTER `configure_logging()` but BEFORE `initialize_services()`.
      - Pass `settings` as a parameter to `initialize_services(settings)`.
      - Replace `port = int(os.environ.get("WEBHOOK_PORT", "8000"))` with `port = settings.webhook_port`.
      - Replace `gmail_topic = os.environ.get("GMAIL_PUBSUB_TOPIC", "")` with `gmail_topic = settings.gmail_pubsub_topic`.
   c. In `configure_logging()`:
      - Keep accepting `production: bool` parameter (the caller passes `settings.production`). Remove the internal `os.environ.get("PRODUCTION")` fallback.
   d. Change `initialize_services()` signature to `initialize_services(settings: Settings | None = None)` (None default preserves backward compat for tests). Inside, do `if settings is None: settings = get_settings()`.
      - Replace `audit_db_path = Path(os.environ.get("AUDIT_DB_PATH", "data/audit.db"))` with `audit_db_path = settings.audit_db_path`
      - Replace `slack_bot_token = os.environ.get("SLACK_BOT_TOKEN")` with `slack_bot_token = settings.slack_bot_token.get_secret_value() or None` (empty string becomes None for the existing conditional logic)
      - Replace `os.environ.get("SLACK_ESCALATION_CHANNEL", "")` with `settings.slack_escalation_channel`
      - Replace `os.environ.get("SLACK_AGREEMENT_CHANNEL", "")` with `settings.slack_agreement_channel`
      - Replace `os.environ.get("GOOGLE_SHEETS_KEY")` with `settings.google_sheets_key or None`
      - Replace `os.environ.get("GMAIL_TOKEN_PATH")` with `str(settings.gmail_token_path) if settings.gmail_token_path != Path("token.json") or settings.gmail_token_path.exists() else None`. Simpler: just use `str(settings.gmail_token_path)` and let the GmailClient init handle file-not-found (existing try/except catches it). So: `gmail_token = str(settings.gmail_token_path)` and check `if settings.gmail_token_path.exists():` instead of `if gmail_token:`.
      - Replace both `os.environ.get("AGENT_EMAIL", "")` with `settings.agent_email`
      - Replace `os.environ.get("ANTHROPIC_API_KEY")` with `settings.anthropic_api_key.get_secret_value() or None`
      - Replace `os.environ.get("CLICKUP_API_TOKEN", "")` with `settings.clickup_api_token`
      - Pass `bot_token=slack_bot_token` explicitly to `create_slack_app()` (already does this)
   e. In `lifespan()`: Replace `os.environ.get("GMAIL_PUBSUB_TOPIC", "")` with reading from `app.state.settings.gmail_pubsub_topic`. Store settings on `app.state` in `create_app()`: `fastapi_app.state.settings = settings`. Alternatively, store `gmail_pubsub_topic` in services dict during init for simpler access.
   f. In `renew_gmail_watch_periodically()`: Replace `os.environ.get("GMAIL_PUBSUB_TOPIC", "")` with getting the topic from services dict (add `services["gmail_pubsub_topic"] = settings.gmail_pubsub_topic` in initialize_services).
   g. In `run_slack_bot()`: Replace `os.environ.get("SLACK_APP_TOKEN")` with getting from services dict (add `services["slack_app_token"] = settings.slack_app_token.get_secret_value()` in initialize_services).
   h. Remove `import os` from the file once all os.environ calls are gone.

2. **src/negotiation/auth/credentials.py** (1 os.environ call):
   - In `get_sheets_client()`: Remove the `os.environ.get("SHEETS_SERVICE_ACCOUNT_PATH")` fallback. The function already accepts `service_account_path` as a parameter -- callers (app.py) will now pass `settings.sheets_service_account_path`. Keep the function signature as-is but remove the env var lookup inside. The function becomes: if arg provided, use it; else use gspread default.
   - Remove `import os` from the file.

3. **src/negotiation/slack/app.py** (2 os.environ calls):
   - In `create_slack_app()`: Remove `os.environ["SLACK_BOT_TOKEN"]` fallback. Make `bot_token` required (the caller in app.py always provides it now). Raise `ValueError("bot_token is required")` if None.
   - In `start_slack_app()`: Remove `os.environ["SLACK_APP_TOKEN"]` fallback. Make `app_token` required similarly.
   - Remove `import os` from the file.

4. **src/negotiation/slack/client.py** (1 os.environ call):
   - In `SlackNotifier.__init__()`: Remove `os.environ["SLACK_BOT_TOKEN"]` fallback. Make `bot_token` required (caller always provides it). Change signature: `bot_token: str` (no None default).
   - Remove `import os` from the file.

5. **src/negotiation/campaign/webhook.py** (1 os.environ call):
   - In `clickup_webhook()`: Replace `os.environ.get("CLICKUP_WEBHOOK_SECRET", "")` with `request.app.state.settings.clickup_webhook_secret`. This requires `app.state.settings` to be set in `create_app()` (done in step 1e above).
   - Remove `import os` from the file.

6. **src/negotiation/audit/cli.py** (1 os.environ call):
   - In `build_parser()`: Replace `os.environ.get("AUDIT_DB_PATH", "data/audit.db")` default with a static default `"data/audit.db"`. The CLI is a standalone tool; it should read its own default, not pull from the app Settings. However, update `main()` to optionally check Settings if `--db` is not explicitly provided. Simplest: just replace the os.environ default with the string literal `"data/audit.db"` since the CLI arg `--db` already handles override.
   - Remove `import os` from the file.

7. After all changes, verify with: `grep -r "os\.environ" src/negotiation/` -- should return ZERO matches in application code.
  </action>
  <verify>
    - `grep -rn "os\.environ" src/negotiation/` returns zero matches
    - `grep -rn "import os" src/negotiation/` returns zero matches (all os imports removed)
    - `ruff check src/negotiation/` passes with no errors
    - `python -c "from negotiation.app import initialize_services"` imports without error
    - `python -c "from negotiation.config import get_settings; s = get_settings(); print(s.production, s.webhook_port)"` prints `False 8000`
  </verify>
  <done>
    All 22 os.environ calls across 6 source files are replaced with Settings-derived values. No raw os.environ calls remain in src/negotiation/. The import os statement is removed from all application modules. validate_credentials() is called in main() before service initialization.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "os\.environ" src/negotiation/` returns zero matches
2. `python -c "from negotiation.config import Settings; s = Settings(); print(s.model_fields.keys())"` shows all 15+ fields
3. `ruff check src/negotiation/` passes
4. `python -c "from negotiation.app import main"` imports without circular import errors
</verification>

<success_criteria>
- pydantic-settings is installed and the Settings class loads all 15 environment variables with correct types and defaults
- Zero os.environ calls remain in any src/negotiation/ module
- validate_credentials() exits with clear errors in production mode when credentials are missing
- validate_credentials() logs warnings but allows startup in development mode
- No circular imports between config.py and other modules
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-and-health-infrastructure/08-01-SUMMARY.md`
</output>

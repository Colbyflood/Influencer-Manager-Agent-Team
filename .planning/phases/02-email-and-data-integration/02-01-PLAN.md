---
phase: 02-email-and-data-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - uv.lock
  - src/negotiation/auth/__init__.py
  - src/negotiation/auth/credentials.py
  - src/negotiation/email/__init__.py
  - src/negotiation/email/models.py
  - src/negotiation/sheets/__init__.py
  - src/negotiation/sheets/models.py
  - tests/auth/__init__.py
  - tests/auth/test_credentials.py
  - tests/email/__init__.py
  - tests/email/test_models.py
  - tests/sheets/__init__.py
  - tests/sheets/test_models.py
  - .gitignore
autonomous: true
requirements:
  - EMAIL-01
  - EMAIL-03
  - DATA-02

user_setup:
  - service: google-cloud
    why: "Gmail API and Google Sheets API require GCP project with OAuth2 credentials"
    env_vars:
      - name: GMAIL_CREDENTIALS_PATH
        source: "GCP Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID -> Download JSON -> save as credentials.json"
      - name: GMAIL_TOKEN_PATH
        source: "Auto-generated on first OAuth2 flow run (token.json)"
      - name: SHEETS_SERVICE_ACCOUNT_PATH
        source: "GCP Console -> IAM & Admin -> Service Accounts -> Create Key -> JSON -> save as service_account.json"
    dashboard_config:
      - task: "Enable Gmail API"
        location: "GCP Console -> APIs & Services -> Library -> Gmail API -> Enable"
      - task: "Enable Google Sheets API"
        location: "GCP Console -> APIs & Services -> Library -> Google Sheets API -> Enable"
      - task: "Create OAuth2 Client ID (Desktop app)"
        location: "GCP Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth client ID -> Application type: Desktop app"
      - task: "Configure OAuth consent screen with gmail.send and gmail.readonly scopes"
        location: "GCP Console -> APIs & Services -> OAuth consent screen -> Edit App -> Add scopes"
      - task: "Create service account for Sheets access"
        location: "GCP Console -> IAM & Admin -> Service Accounts -> Create Service Account"
      - task: "Share the influencer Google Sheet with the service account email"
        location: "Google Sheets -> Share -> Add service account email as Viewer"

must_haves:
  truths:
    - "All Phase 2 dependencies (google-api-python-client, google-auth, gspread, mail-parser-reply, etc.) install cleanly"
    - "OAuth2 credential loading function handles token.json present, token.json missing, and token.json expired cases"
    - "Service account credential loading function works for gspread"
    - "EmailThreadContext, InboundEmail, and OutboundEmail Pydantic models validate correctly"
    - "InfluencerRow model coerces float values from Sheets to Decimal without precision loss"
  artifacts:
    - path: "src/negotiation/auth/credentials.py"
      provides: "Gmail OAuth2 and Sheets service account credential management"
      exports: ["get_gmail_credentials", "get_gmail_service", "get_sheets_client"]
    - path: "src/negotiation/email/models.py"
      provides: "Email-domain Pydantic models"
      exports: ["EmailThreadContext", "InboundEmail", "OutboundEmail"]
    - path: "src/negotiation/sheets/models.py"
      provides: "Sheet-domain Pydantic models"
      exports: ["InfluencerRow"]
  key_links:
    - from: "src/negotiation/sheets/models.py"
      to: "src/negotiation/domain/types.py"
      via: "imports Platform enum"
      pattern: "from negotiation\\.domain\\.types import Platform"
    - from: "src/negotiation/sheets/models.py"
      to: "src/negotiation/domain/models.py"
      via: "InfluencerRow.to_pay_range() converts to existing PayRange"
      pattern: "PayRange"
---

<objective>
Install all Phase 2 dependencies, create the shared authentication module for Google APIs, and define Pydantic models for email and sheets domains.

Purpose: Every other Phase 2 plan depends on (a) the libraries being installed, (b) authentication working, and (c) domain models existing. This plan creates that shared foundation.

Output: Auth module with Gmail OAuth2 + Sheets service account credential helpers, email Pydantic models (EmailThreadContext, InboundEmail, OutboundEmail), sheets Pydantic model (InfluencerRow), and all external dependencies installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-and-data-integration/02-RESEARCH.md
@.planning/phases/01-core-domain-and-pricing-engine/01-01-SUMMARY.md
@src/negotiation/domain/types.py
@src/negotiation/domain/models.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Phase 2 dependencies and update .gitignore</name>
  <files>
    pyproject.toml
    uv.lock
    .gitignore
  </files>
  <action>
    Add all Phase 2 runtime dependencies to pyproject.toml:
    ```
    uv add google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2 gspread "mail-parser-reply>=1.36" google-cloud-pubsub
    ```
    Add dev dependency for type stubs:
    ```
    uv add --group dev google-api-python-client-stubs
    ```
    Update .gitignore to exclude credential files (append to existing):
    ```
    # Google API credentials (never commit)
    credentials.json
    token.json
    service_account.json
    ```
    Verify all imports work:
    ```
    uv run python -c "from googleapiclient.discovery import build; import google.auth; import gspread; from mailparser_reply import EmailReplyParser; print('All imports OK')"
    ```
  </action>
  <verify>
    `uv run python -c "from googleapiclient.discovery import build; import google.auth; import gspread; from mailparser_reply import EmailReplyParser; print('OK')"` prints OK.
    .gitignore contains credential exclusions.
  </verify>
  <done>All 7 runtime + 1 dev dependency installed. Credential files excluded from git.</done>
</task>

<task type="auto">
  <name>Task 2: Create auth module, email models, sheets models, and tests</name>
  <files>
    src/negotiation/auth/__init__.py
    src/negotiation/auth/credentials.py
    src/negotiation/email/__init__.py
    src/negotiation/email/models.py
    src/negotiation/sheets/__init__.py
    src/negotiation/sheets/models.py
    tests/auth/__init__.py
    tests/auth/test_credentials.py
    tests/email/__init__.py
    tests/email/test_models.py
    tests/sheets/__init__.py
    tests/sheets/test_models.py
  </files>
  <action>
    **src/negotiation/auth/credentials.py:**
    Create three functions:
    1. `get_gmail_credentials(token_path, credentials_path, scopes) -> Credentials` -- Loads OAuth2 credentials from token.json. If missing or expired, runs `InstalledAppFlow.run_local_server()` to create them. Persists refreshed token. Default scopes: `gmail.send` + `gmail.readonly`. Follow the exact pattern from research Pattern: "Credential Management".
    2. `get_gmail_service(credentials) -> Resource` -- Builds Gmail API v1 service via `build("gmail", "v1", credentials=creds)`.
    3. `get_sheets_client(service_account_path) -> gspread.Client` -- Loads gspread client via `gspread.service_account(filename=path)`. Default path from env var `SHEETS_SERVICE_ACCOUNT_PATH` or `~/.config/gspread/service_account.json`.

    Define module-level constants:
    - `DEFAULT_GMAIL_SCOPES = ["https://www.googleapis.com/auth/gmail.send", "https://www.googleapis.com/auth/gmail.readonly"]`
    - `DEFAULT_TOKEN_PATH = "token.json"`
    - `DEFAULT_CREDENTIALS_PATH = "credentials.json"`

    **src/negotiation/email/models.py:**
    Create 3 frozen Pydantic models following the research examples:
    1. `EmailThreadContext` -- thread_id: str, last_message_id: str (RFC 2822 Message-ID), subject: str, influencer_email: str
    2. `InboundEmail` -- gmail_message_id: str, thread_id: str, message_id_header: str, from_email: str, subject: str, body_text: str, received_at: str (ISO 8601)
    3. `OutboundEmail` -- to: str, subject: str, body: str, thread_id: str | None = None, in_reply_to: str | None = None, references: str | None = None

    All models use `ConfigDict(frozen=True)`.

    **src/negotiation/sheets/models.py:**
    Create 1 frozen Pydantic model:
    1. `InfluencerRow` -- name: str, email: str, platform: Platform (imported from domain), handle: str, average_views: int, min_rate: Decimal, max_rate: Decimal

    Add `coerce_from_sheet_float` field_validator on min_rate and max_rate that converts float -> str before Decimal parsing (Google Sheets returns floats). This prevents the PayRange float rejection from triggering.

    Add `views_must_be_positive` validator on average_views.

    Add a `to_pay_range()` method that returns a `PayRange(min_rate=self.min_rate, max_rate=self.max_rate, average_views=self.average_views)` -- bridging sheet data to the existing domain model.

    **__init__.py files:** Re-export all public names from each module. Sort `__all__` alphabetically per ruff RUF022.

    **Tests:**
    - `tests/auth/test_credentials.py`: Test that `get_gmail_credentials` calls the right google-auth functions (use `unittest.mock.patch` to mock `Credentials.from_authorized_user_file`, `InstalledAppFlow`, file I/O). Test `get_gmail_service` builds with correct args. Test `get_sheets_client` calls `gspread.service_account`. ~10-15 tests.
    - `tests/email/test_models.py`: Test all 3 models create correctly, test frozen immutability, test that EmailThreadContext requires all fields, test OutboundEmail optional fields default to None. ~15-20 tests.
    - `tests/sheets/test_models.py`: Test InfluencerRow creation with valid data, test float coercion on min_rate/max_rate (pass float, verify Decimal result), test views_must_be_positive rejects 0 and negative, test to_pay_range() returns correct PayRange, test platform validation accepts all 3 platforms. ~10-15 tests.

    Run full verification: `uv run pytest`, `uv run ruff check src/ tests/`, `uv run ruff format --check src/ tests/`, `uv run mypy src/`.
  </action>
  <verify>
    `uv run pytest` -- all tests pass (existing 227 + new ~40-50).
    `uv run ruff check src/ tests/` -- clean.
    `uv run ruff format --check src/ tests/` -- clean.
    `uv run mypy src/` -- clean (may need type: ignore for google API untyped imports).
  </verify>
  <done>
    Auth module loads Gmail OAuth2 credentials (with token refresh) and Sheets service account credentials.
    EmailThreadContext, InboundEmail, OutboundEmail models validate email domain data.
    InfluencerRow model coerces Sheet floats to Decimal and bridges to PayRange via to_pay_range().
    All tests pass, linters clean, mypy clean.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from negotiation.auth import get_gmail_credentials, get_gmail_service, get_sheets_client"` succeeds
2. `uv run python -c "from negotiation.email import EmailThreadContext, InboundEmail, OutboundEmail"` succeeds
3. `uv run python -c "from negotiation.sheets import InfluencerRow"` succeeds
4. `uv run python -c "from negotiation.sheets.models import InfluencerRow; r = InfluencerRow(name='Test', email='t@t.com', platform='instagram', handle='@test', average_views=50000, min_rate=1000.0, max_rate=1500.0); print(type(r.min_rate))"` prints `<class 'decimal.Decimal'>`
5. `uv run pytest` -- all tests pass
6. `uv run ruff check src/ tests/` -- clean
</verification>

<success_criteria>
- All Phase 2 Python dependencies installed and importable
- Auth module provides credential helpers for Gmail (OAuth2) and Sheets (service account)
- Email Pydantic models (EmailThreadContext, InboundEmail, OutboundEmail) validate correctly
- InfluencerRow model coerces Sheets floats to Decimal and converts to PayRange
- Credential files excluded from git via .gitignore
- ~40-50 new tests pass alongside existing 227 tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-and-data-integration/02-01-SUMMARY.md`
</output>
